---
title: Risk Model Validation and Refinement for wound infection after revascularization
  for PAD
author: Eden Singh and Adam Johnson
date: "`r format(Sys.Date(), '%B %d, %Y')`"
output:
  word_document:
knit: (function(input, ...) {rmarkdown::render(input, output_file = paste0(tools::file_path_sans_ext(basename(input)), '-', Sys.Date(), '.docx'))})
---
# Purpose Statement:

This project aims to develop and validate a risk model for wound infections. This analysis describes the validation of previously published risk models for wound infection in the NSQIP procedure targeted data sets.

# Data:

NSQIP Participant Use Files (PUF), inclusive of the aortoiliac open and lower extremity open procedure targeted data sets, from 2013-2020 were queried for this study. We utilized the NSQIPR package to clean the data and organize into relational data sets. The tidyverse, tidymodels, and finalfit packages were then used to analyze the data.

```{r packages, echo=FALSE, message=FALSE, warning=FALSE, results='hide'}
library(tidyverse)
library(finalfit)
library(tidymodels)
library(probably)
library(survival)
library(survminer)
library(predtools)
library(magrittr)
library(Hmisc)
library(labelled)
```

We import data that was selected from the PUF files with the following CPT codes to identify the procedures that involved an open groin incision:

| Procedure Category                | CPT Codes                                                      |
|-----------------------------------|----------------------------------------------------------------|
| Aortofemoral                      | 35539, 35540, 355546, 35548, 35551, 35582, 35646, 35647, 35651 |
| Iliofemoral                       | 35565, 35665                                                   |
| Axillary-femoral                  | 35521, 35533, 35621, 35654                                     |
| Fem-fem                           | 34520, 35558, 35661                                            |
| Embolectomy                       | 34201                                                          |
| CFEA                              | 35355, 35363, 35371, 35372, 35381                              |
| Femoral Aneurysm                  | 35131, 35132, 35721                                            |
| Fem-popliteal bypass              | 35556, 35583, 35656                                            |
| Fem-tibial                        | 35566, 35585, 35666                                            |
| Redo fem-pop or fem-tibial bypass | 35700, 35883, 35884                                            |

```{r import dat, echo=FALSE, warning=FALSE, message=FALSE}

#Import data created using "vasc-fem-inf-nsqip-select.rmd"

puf_pad_grninf_clean <- readRDS("P:/Pro00113988 - PAD Risk Models/DataRepo/NSQIP/Analysis Data Files/puf_pad.rds")

```


# Variable Definitions

```{r prep var, echo=FALSE, warning=FALSE, message=FALSE}

# Select for relevant preop variables

grninf_preop_var <- c("caseid",
                     "supinfec", "wndinfd","orgspcssi", 
                     "operyr", "transt", "sex", "race", "age", "weight", "height",
                     "pad_sympt", "pad_hrf_anat",
                     "anesthes", "surgspec", "emergncy", 
                     "optime", "cpt", "podiag", "podiagtx", "podiag10", "podiagtx10",
                     "wndclas", "asaclas",
                     "hypermed", "hxchf", "insulin", "smoke", "fnstatus2", "hxcopd", "ascites",
                     "renafail", "dialysis", "discancr", "wndinf", "steroid",
                     "wtloss", "bleeddis", "when_dyspnea", "type_prsepis",
                     "prsodm", "prbun", "prcreat", "prbun", "prwbc", "prhct", "prplate", "pralbum"
                     )

puf_pad_grninf_preop <- puf_pad_grninf_clean[, grninf_preop_var, drop = FALSE]

rm(list = c("puf_pad_grninf_clean", "grninf_preop_var"))

## Label Variables

label(puf_pad_grninf_preop$operyr) <- "Year"
label(puf_pad_grninf_preop$sex) <- "Sex"
label(puf_pad_grninf_preop$race) <- "Race"
label(puf_pad_grninf_preop$age) <- "Age (Years)"

# select variable names that start with pad

#col_names <- colnames(puf_pad_grninf_clean)
#pad_variables <- col_names[grep("^pad", col_names)]

```

```{r address missing, echo=FALSE, warning=FALSE, message=FALSE}

# Add unknown variable for procedure specific variables

levels(puf_pad_grninf_preop$pad_sympt) <- c(levels(puf_pad_grninf_preop$pad_sympt), 'Unknown')
puf_pad_grninf_preop$pad_sympt[is.na(puf_pad_grninf_preop$pad_sympt)] <- 'Unknown'

levels(puf_pad_grninf_preop$pad_hrf_anat) <- c(levels(puf_pad_grninf_preop$pad_hrf_anat), 'Unknown')
puf_pad_grninf_preop$pad_hrf_anat[is.na(puf_pad_grninf_preop$pad_hrf_anat)] <- 'Unknown'

# Combine ICD variable

# Ensure 'podiag' and 'podiag10' are characters
puf_pad_grninf_preop$podiag <- as.character(puf_pad_grninf_preop$podiag)
puf_pad_grninf_preop$podiag10 <- as.character(puf_pad_grninf_preop$podiag10)

# Create a new variable that combines 'podiag' and 'podiag10'
puf_pad_grninf_preop$podiag_combined <- ifelse(is.na(puf_pad_grninf_preop$podiag) | puf_pad_grninf_preop$podiag == "", puf_pad_grninf_preop$podiag10, puf_pad_grninf_preop$podiag)

# Convert pod_combine back to factor and remove other variables.
puf_pad_grninf_preop$podiag_combined <- as.factor(puf_pad_grninf_preop$podiag_combined)

puf_pad_grninf_preop <- puf_pad_grninf_preop[ , !(names(puf_pad_grninf_preop) %in% c("podiag", "podiag10"))]

# Ensure 'podiagtx' and 'podiagtx10' are characters
puf_pad_grninf_preop$podiagtx <- as.character(puf_pad_grninf_preop$podiagtx)
puf_pad_grninf_preop$podiagtx10 <- as.character(puf_pad_grninf_preop$podiagtx10)

# Create a new variable that combines 'podiag' and 'podiag10'
puf_pad_grninf_preop$podiagtx_combined <- ifelse(is.na(puf_pad_grninf_preop$podiagtx) | puf_pad_grninf_preop$podiagtx == "", puf_pad_grninf_preop$podiagtx10, puf_pad_grninf_preop$podiagtx)

# Convert pod_combine back to factor and remove other variables.
puf_pad_grninf_preop$podiagtx_combined <- as.factor(puf_pad_grninf_preop$podiagtx_combined)

puf_pad_grninf_preop <- puf_pad_grninf_preop[ , !(names(puf_pad_grninf_preop) %in% c("podiagtx", "podiagtx10"))]

# Add 'None' value to stratified comorbidity variables

puf_pad_grninf_preop$dm_insulin <- ifelse(puf_pad_grninf_preop$insulin == TRUE, 'Insulin', 
             ifelse(puf_pad_grninf_preop$insulin == FALSE, 'Meds or Diet', 'None'))
levels(puf_pad_grninf_preop$dm_insulin) <- c(levels(puf_pad_grninf_preop$dm_insulin), 'None')
puf_pad_grninf_preop$dm_insulin[is.na(puf_pad_grninf_preop$dm_insulin)] <- 'None'
puf_pad_grninf_preop$dm_insulin <- as.factor(puf_pad_grninf_preop$dm_insulin)

puf_pad_grninf_preop <- puf_pad_grninf_preop[ , !(names(puf_pad_grninf_preop) %in% c("insulin"))]

levels(puf_pad_grninf_preop$when_dyspnea) <- c(levels(puf_pad_grninf_preop$when_dyspnea), 'None')
puf_pad_grninf_preop$when_dyspnea[is.na(puf_pad_grninf_preop$when_dyspnea)] <- 'None'

levels(puf_pad_grninf_preop$type_prsepis) <- c(levels(puf_pad_grninf_preop$type_prsepis), 'None')
puf_pad_grninf_preop$type_prsepis[is.na(puf_pad_grninf_preop$type_prsepis)] <- 'None'

# Keep only cases with no missing variables

#puf_pad_grninf_preop <- na.omit(puf_pad_grninf_preop)
#puf_pad_grninf_preop <- droplevels(puf_pad_grninf_preop)

```


The outcome of interest for our study is the development of a superifical incisional, deep incisional or organ space wound infection in these procedures that include a groin incision in the 30d post operative period. NSQIP defines infection as superifical, deep space or organ space.

```{r create outcome, echo=FALSE, warning=FALSE, message=FALSE}

puf_pad_grninf_preop <- puf_pad_grninf_preop %>%
  mutate(grninf = supinfec | wndinfd | orgspcssi)
label(puf_pad_grninf_preop$grninf) <- "Any Groin SSI"

puf_pad_grninf_preop <- puf_pad_grninf_preop %>%
  mutate(s_grninf = wndinfd | orgspcssi)
label(puf_pad_grninf_preop$grninf) <- "Severe Groin SSI"


puf_pad_grninf_preop <- puf_pad_grninf_preop[ , !(names(puf_pad_grninf_preop) %in% c("supinfec", "wndinfd","orgspcssi"))]

```


```{r table 1, warning=FALSE, echo=FALSE, message=FALSE}

##Create table one with cohort descriptive statistics for age, gender, race, year, indication and procedure.

## Truncate year
puf_pad_grninf_preop$operyr_trunc <- substr(puf_pad_grninf_preop$operyr, 1, 4)
puf_pad_grninf_preop$operyr_trunc <- as.factor(puf_pad_grninf_preop$operyr_trunc)
puf_pad_grninf_preop <- puf_pad_grninf_preop[ , !(names(puf_pad_grninf_preop) %in% c("operyr"))]
label(puf_pad_grninf_preop$operyr_trunc) <- "Operative Year"

## Create variables for indications
source("P:/Pro00113988 - PAD Risk Models/Vasc Fem Inf/vasc_fem_inf/code/vasc_fem_inf_icd_groups.R")

puf_pad_grninf_preop <- puf_pad_grninf_preop %>%
  mutate(indication = case_when(
    puf_pad_grninf_preop$pad_sympt == "Claudication" |
      puf_pad_grninf_preop$podiag_combined %in% icd_claudication ~ "Claudication",
    puf_pad_grninf_preop$pad_sympt == "Rest pain" |
      puf_pad_grninf_preop$podiag_combined %in% icd_rest_pain ~ "Rest Pain",
    puf_pad_grninf_preop$pad_sympt == "Tissue loss" |
      puf_pad_grninf_preop$podiag_combined %in% icd_tissue == TRUE ~ "Tissue Loss",
    puf_pad_grninf_preop$podiag_combined %in% icd_embo == TRUE ~ "Acute Limb Ischemia",
    TRUE ~ "Unspecified"
  ))
puf_pad_grninf_preop$indication <- factor(puf_pad_grninf_preop$indication, 
                                          levels = c("Claudication", "Rest Pain", "Tissue Loss", 
                                                     "Acute Limb Ischemia", "Unspecified"))
label(puf_pad_grninf_preop$indication) <- "Indication"

summary(puf_pad_grninf_preop$indication)

# Create variables for other procedure classes based on CPT
source("P:/Pro00113988 - PAD Risk Models/Vasc Fem Inf/vasc_fem_inf/code/vasc_fem_inf_cpt_groups.R")

## Create variable for aortofem

puf_pad_grninf_preop <- puf_pad_grninf_preop %>%
  mutate(proc = case_when(
    puf_pad_grninf_preop$cpt %in% cpt_aortofem |
      puf_pad_grninf_preop$cpt %in% cpt_iliofem ~ "Aorto or Iliofemoral Bypass",
    puf_pad_grninf_preop$cpt %in% cpt_axfem ~ "Axillofemoral Bypass", 
    puf_pad_grninf_preop$cpt %in% cpt_femfem ~ "Fem Fem Bypass",
    puf_pad_grninf_preop$cpt %in% cpt_cfea == TRUE |
      puf_pad_grninf_preop$cpt %in% cpt_femaneur ~ "Femoral Revasc", 
    puf_pad_grninf_preop$cpt %in% cpt_fempop ~ "Fem Pop Bypass",
    puf_pad_grninf_preop$cpt %in% cpt_femtib ~ "Fem Tib Bypass",
    TRUE ~ "Other"
  ))
puf_pad_grninf_preop$proc <- factor(puf_pad_grninf_preop$proc, 
                                    levels = c("Aorto or Iliofemoral Bypass", "Axillofemoral Bypass", "Fem Fem Bypass",
                                               "Femoral Revasc", "Fem Pop Bypass", "Fem Tib Bypass", "Other"))
label(puf_pad_grninf_preop$proc) <- "Procedure"

t1_exp <- c("age", "sex", "race", "indication", "proc")
dep_1 <- "grninf"
dep_2 <- "s_grninf"
puf_pad_grninf_preop %>%
  summary_factorlist(dep_1, t1_exp,
                     add_col_totals = TRUE,
                     include_col_totals_percent = FALSE,
                     col_totals_rowname = "",
                     col_totals_prefix = "N=",
                     total_col = TRUE) -> t1_1

t1_1 <- t1_1 %>%
  select(1, 2, 4, 5) %>%
  rename("Any Groin SSI" = "TRUE")

puf_pad_grninf_preop %>%
  summary_factorlist(dep_2, t1_exp,
                     add_col_totals = TRUE,
                     include_col_totals_percent = FALSE,
                     col_totals_rowname = "",
                     col_totals_prefix = "N=",
                     total_col = TRUE) -> t1_2

t1_2 <- t1_2 %>%
  select(4) %>%
  rename("Severe Groin SSI" = "TRUE")

t1 <- t1_1 %>%
  bind_cols(t1_2) %>%
  select(1, 2, 3, 5, 4)

knitr::kable(t1, align = c("l", "l", "r", "r", "r"))
```


We then mapped the pre-operative variables in the NSQIP data dictionary to those features described in in the previously published wound infection models. Decisions related to variable mapping are included in the code notes.

# Variable Mapping

## Gwilym et al Model

```{r Gwilym variables, warning=FALSE, echo=FALSE}
#Gwilym variables: female, BMI, ischemic heart disease, skin preparation, bypass/graft material, operative time

# We will use the sex variable for female
puf_pad_grninf_preop$female <- ifelse(puf_pad_grninf_preop$sex == "Female", TRUE, FALSE)
puf_pad_grninf_preop <- puf_pad_grninf_preop[ , !(names(puf_pad_grninf_preop) %in% c("sex"))]
label(puf_pad_grninf_preop$female) <- "Female Sex"

# Create dummy variables for underweight, overweight and obese
puf_pad_grninf_preop$BMI <- 703*(puf_pad_grninf_preop$weight/(puf_pad_grninf_preop$height^2))

puf_pad_grninf_preop$underweight <- ifelse(puf_pad_grninf_preop$BMI < "18.5", TRUE, FALSE)
puf_pad_grninf_preop$underweight <- ifelse(is.na(puf_pad_grninf_preop$underweight), 
                                         FALSE, puf_pad_grninf_preop$underweight)
label(puf_pad_grninf_preop$underweight) <- "Underweight (BMI<18)"

puf_pad_grninf_preop$overweight <- ifelse(puf_pad_grninf_preop$BMI > "25" & puf_pad_grninf_preop$BMI < "30", TRUE, FALSE)
puf_pad_grninf_preop$overweight <- ifelse(is.na(puf_pad_grninf_preop$overweight), 
                                           FALSE, puf_pad_grninf_preop$overweight)
label(puf_pad_grninf_preop$overweight) <- "Overweight (25<BMI<30)"

puf_pad_grninf_preop$obese <- ifelse(puf_pad_grninf_preop$BMI > "30", TRUE, FALSE)
puf_pad_grninf_preop$obese <- ifelse(is.na(puf_pad_grninf_preop$obese), 
                                          FALSE, puf_pad_grninf_preop$obese)
label(puf_pad_grninf_preop$obese) <- "Obese (BMI>30)"

puf_pad_grninf_preop <- puf_pad_grninf_preop[ , !(names(puf_pad_grninf_preop) %in% c("height", "weight"))]

#Create variable ischemic heart disease using presence of HTN or CHF. Unfortunately, both hxmi and hxangina are retired variables and missing in this dataset.  The pad_hrf_phys includes whether there is a recent MI, but this is a composite variable and it does not distinguish whether the high risk feature is related to ischemic heart disease.
puf_pad_grninf_preop$heart_dz <- ifelse(puf_pad_grninf_preop$hxchf == "TRUE" | 
                                          puf_pad_grninf_preop$hypermed == 'TRUE', TRUE, FALSE)
label(puf_pad_grninf_preop$heart_dz) <- "Ischemic Heart Disease"


# Create variable Skin_preparation.  The common practice in the US is to utilize alcoholic chlorhexidine, which seemed to be the majority of cases in this study and there was no difference when compared with aqueous chlorhexidine, alcoholic betadine or two solutions.  The only solution strongly associated with wound infection would be aqueous betadine.  In my practice, I only use these when there is an open wound.  Therefore, I think it would be reasonable to utilize wndinf variable as a proxy for this.
puf_pad_grninf_preop$prep_aq_beta <- ifelse(puf_pad_grninf_preop$wndinf == TRUE | 
                                          puf_pad_grninf_preop$wndclas == "2" | 
                                          puf_pad_grninf_preop$wndclas == "3" | 
                                          puf_pad_grninf_preop$wndclas == "4", 
                                        TRUE, FALSE)
label(puf_pad_grninf_preop$prep_aq_beta) <- "Skin Prep: Aqueous Betadine"


# Create variable for vein bypass material based on CPT, based on previously developed CPT groupings.
source("P:/Pro00113988 - PAD Risk Models/Vasc Fem Inf/vasc_fem_inf/code/vasc_fem_inf_cpt_groups.R")

puf_pad_grninf_preop$vein <- ifelse(puf_pad_grninf_preop$cpt %in% cpt_vein, TRUE, FALSE)
label(puf_pad_grninf_preop$vein) <- "Bypass Conduit: Vein"

## Create variable for xenograft material - most often used for patches for CFEA however SHOULD NOT MAKE THIS ASSUMPTION, PER DR. MUREEBE - therefore we will not include this variable in the model as there is no way to clearly map this variable.
#puf_pad_grninf_preop$patch <- ifelse(puf_pad_grninf_preop$cpt %in% cpt_patch, TRUE, FALSE)

## Create variable for prosthetic material
puf_pad_grninf_preop$prsth <- ifelse(puf_pad_grninf_preop$cpt %in% cpt_prsth, TRUE, FALSE)
label(puf_pad_grninf_preop$prsth) <- "Bypass Conduit: Prosthetic"

# Create variable for operative time by dividing the optime minutes by 60
puf_pad_grninf_preop$optime_hrs <- ((puf_pad_grninf_preop$optime)/60)
puf_pad_grninf_preop <- puf_pad_grninf_preop %>%
  mutate(optime_hrs = as.numeric(optime_hrs))
#label(puf_pad_grninf_preop$optime_hrs) <- "Operative Time (Hours)" - LABELS DO NOT WORK WITH SUMMMARY_FACTORLIST - Will need to use function specific labeling.

#Create summary table
g_exp <- c("female", "underweight", "overweight", "obese", "heart_dz", "prep_aq_beta", "vein", "prsth", "optime_hrs")
dep_1 <- "grninf"
dep_2 <- "s_grninf"
exp <- g_exp

puf_pad_grninf_preop %>%
  summary_factorlist(dep_1, exp, p=TRUE,
                     add_col_totals = TRUE,
                     include_col_totals_percent = FALSE,
                     col_totals_rowname = "",
                     col_totals_prefix = "N=") -> t2_1

t2_1 <- t2_1 %>%
  select(1,2,4,5) %>%
  rename("Any Groin SSI" = "TRUE")

puf_pad_grninf_preop %>%
  summary_factorlist(dep_2, exp, p=TRUE,
                     add_col_totals = TRUE,
                     include_col_totals_percent = FALSE,
                     col_totals_rowname = "",
                     col_totals_prefix = "N=",
                     total_col = TRUE) -> t2_2

selected_columns <- t2_2 %>%
  select(4,6,5) %>%
  rename("Severe Groin SSI" = "TRUE")

t2 <- t2_1 %>%
  bind_cols(selected_columns)

knitr::kable(t2, align = c("l", "l", "c", "c", "c", "c", "r"))

```

## Leekha et al Mapping

```{r Leekha Variables, warning=FALSE, echo=FALSE, message=FALSE}

#Leekha variables: Critical ischemia, COPD, previous revascularization, previous SSI 

#Create variable critical limb ischemia based on PAD symptom variable in NSQIP. PAD symptoms is divided into rest pain, tissue loss, asymptomatic, or claudication. For critical limb ischemia, will include rest pain and tissue loss. However, we will use the abbreviation 'clti' instead of 'cli' to align with more modern disease definitions.
source("P:/Pro00113988 - PAD Risk Models/Vasc Fem Inf/vasc_fem_inf/code/vasc_fem_inf_icd_groups.R")

puf_pad_grninf_preop$clti <-  ifelse(puf_pad_grninf_preop$pad_sympt == "Rest pain" |
                                       puf_pad_grninf_preop$podiag_combined %in% icd_rest_pain |
                                       puf_pad_grninf_preop$pad_sympt == "Tissue loss" |
                                       puf_pad_grninf_preop$podiag_combined %in% icd_tissue, TRUE, FALSE)
puf_pad_grninf_preop$clti <- ifelse(is.na(puf_pad_grninf_preop$clti), 
                                      FALSE, puf_pad_grninf_preop$clti)
label(puf_pad_grninf_preop$clti) <- "Indication: CLTI"

#Utilize hxCOPD variable for COPD. No need to create a new variable.
puf_pad_grninf_preop$copd <- ifelse(puf_pad_grninf_preop$hxcopd == "TRUE", TRUE, FALSE)
label(puf_pad_grninf_preop$copd) <- "COPD"

#Create previous revascularization variable based on "PAD high risk features anatomic". High risk features anatomic is divided into prior ipsilateral bypass, prior percutaneous intervention, and prior abdominal surgery. Leekha et al defines prior revascularization as either a prior surgical or percutaneous revascularization procedure. 
puf_pad_grninf_preop$prrevasc_ips <- ifelse(puf_pad_grninf_preop$pad_hrf_anat == "Prior ipsilateral bypass" | 
                                          puf_pad_grninf_preop$pad_hrf_anat == "Prior ipsilateral percutaneous intervention" |
                                          puf_pad_grninf_preop$podiag_combined %in% icd_prrevasc |
                                          puf_pad_grninf_preop$cpt %in% cpt_prrevasc, TRUE, FALSE)
puf_pad_grninf_preop$prrevasc_ips <- ifelse(is.na(puf_pad_grninf_preop$prrevasc_ips), 
                                      FALSE, puf_pad_grninf_preop$prrevasc_ips)
label(puf_pad_grninf_preop$prrevasc_ips) <- "Previous Ipsilateral Revascularization"

#There is not an equivalent or proxy that is an accurate representation of prior SSI in NSQIP. The closest is "wndinf" but this only classifies is there is a wound infection present at the time of surgery.

l_exp <- c("clti", "hxcopd", "prrevasc_ips")
dep_1 <- "grninf"
dep_2 <- "s_grninf"
exp <- l_exp

puf_pad_grninf_preop %>%
  summary_factorlist(dep_1, exp, p=TRUE,
                     add_col_totals = TRUE,
                     include_col_totals_percent = FALSE,
                     col_totals_rowname = "",
                     col_totals_prefix = "N=") -> t2_1

t2_1 <- t2_1 %>%
  select(1,2,4,5) %>%
  rename("Any Groin SSI" = "TRUE")

puf_pad_grninf_preop %>%
  summary_factorlist(dep_2, exp, p=TRUE,
                     add_col_totals = TRUE,
                     include_col_totals_percent = FALSE,
                     col_totals_rowname = "",
                     col_totals_prefix = "N=",
                     total_col = TRUE) -> t2_2

selected_columns <- t2_2 %>%
  select(4,6,5) %>%
  rename("Severe Groin SSI" = "TRUE")

t2 <- t2_1 %>%
  bind_cols(selected_columns)

knitr::kable(t2, align = c("l", "l", "c", "c", "c", "c", "r"))

```

## Bennett et al Model

```{r Bennett Variables, warning=FALSE, echo=FALSE, message=FALSE}
#We now will create the relevant variables for the Bennett et al.  Bennett variables: Gender, BMI, reoperative groin, ESRD, Malnutrition, Urgent

#For reoperative groin, will utilize the hrf_anat feature. Bennett et al defined reoperative groin as "presence of previous groin incision on ipsilateral side." We will use hrf_anat for previous ipsilateral bypass.

puf_pad_grninf_preop$reop_groin <- ifelse(puf_pad_grninf_preop$pad_hrf_anat == "Prior ipsilateral bypass"| 
                                            puf_pad_grninf_preop$podiag_combined %in% icd_prrevasc |
                                            puf_pad_grninf_preop$cpt %in% cpt_prrevasc, TRUE, FALSE)
puf_pad_grninf_preop$reop_groin <- ifelse(is.na(puf_pad_grninf_preop$reop_groin), 
                                        FALSE, puf_pad_grninf_preop$reop_groin)
label(puf_pad_grninf_preop$reop_groin) <- "Previous Femoral Cutdown"

#No need to create a dummy variable for female. Will use previously created female variable 

#BMI is included as a numeric variable so we will use the previously calculate BMI value in our model.

## We will use dialysis variable.
puf_pad_grninf_preop$esrd <- ifelse(puf_pad_grninf_preop$dialysis == "TRUE", TRUE, FALSE)
label(puf_pad_grninf_preop$esrd) <- "ESRD on Dialysis"

#Create a variable for malnutrition.
## Create a variable for malnutrition based what components are available from PONS (Wischmeyer et al 2018), the components of which are:
## BMI < 18.5; Weightloss >10% in last 6mo; Reduced oral intake by 50% in past week; Preop serum albumin <3.0 g/dL
puf_pad_grninf_preop$malnut <- ifelse(puf_pad_grninf_preop$pralbum < "3.0" | 
                                        puf_pad_grninf_preop$wtloss == "TRUE" | 
                                        puf_pad_grninf_preop$BMI < "18.5", TRUE, FALSE)
puf_pad_grninf_preop$malnut <- ifelse(is.na(puf_pad_grninf_preop$malnut), 
                                          FALSE, puf_pad_grninf_preop$malnut)
label(puf_pad_grninf_preop$malnut) <- "Malnutrition"

#Create a new variable for urgent from emergncy variable
puf_pad_grninf_preop$urgnt <- ifelse(puf_pad_grninf_preop$emergncy == "TRUE", TRUE, FALSE)
label(puf_pad_grninf_preop$urgnt) <- "Urgent/Emergent Procedure"

b_exp <- c("reop_groin", "female", "BMI", "esrd", "malnut", "urgnt")
dep_1 <- "grninf"
dep_2 <- "s_grninf"
exp <- b_exp

puf_pad_grninf_preop %>%
  summary_factorlist(dep_1, exp, p=TRUE,
                     add_col_totals = TRUE,
                     include_col_totals_percent = FALSE,
                     col_totals_rowname = "",
                     col_totals_prefix = "N=") -> t2_1

t2_1 <- t2_1 %>%
  select(1,2,4,5) %>%
  rename("Any Groin SSI" = "TRUE")

puf_pad_grninf_preop %>%
  summary_factorlist(dep_2, exp, p=TRUE,
                     add_col_totals = TRUE,
                     include_col_totals_percent = FALSE,
                     col_totals_rowname = "",
                     col_totals_prefix = "N=",
                     total_col = TRUE) -> t2_2

selected_columns <- t2_2 %>%
  select(4,6,5) %>%
  rename("Severe Groin SSI" = "TRUE")

t2 <- t2_1 %>%
  bind_cols(selected_columns)

knitr::kable(t2, align = c("l", "l", "c", "c", "c", "c", "r"))
```

## Wiseman et al Model

```{r Wiseman Variables, warning=FALSE, echo=FALSE, message=FALSE}
#Wiseman variables based on OR included in Table II: Lower extremity revascularization, aortoilliac procedure, BMI, operative time, female, insulin-dependent diabetes, non-insulin dependent diabetes, smoker, hypertension, critical limb ischemia, dyspnea with moderate exertion, groin anastomosis, ASA class 4 or 5, COPD, CAD, Neurologic disease, age, race, sepsis complication, renal complication, totally dependent functional status, prolonged LOS   

#Create variable for age greater than 65.
puf_pad_grninf_preop$age65 <- ifelse(puf_pad_grninf_preop$age > "65", TRUE, FALSE)
label(puf_pad_grninf_preop$age65) <- "Age >65 Years"

#Create Black race variable from on race variable in NSQIP.
puf_pad_grninf_preop$blkrace <- ifelse(puf_pad_grninf_preop$race == "Black", TRUE, FALSE)
label(puf_pad_grninf_preop$blkrace) <- "Black Race"
puf_pad_grninf_preop$othrace <- ifelse(puf_pad_grninf_preop$race == "American Indian or Alaska native" |
                                         puf_pad_grninf_preop$race == "Some other race" |
                                         puf_pad_grninf_preop$race == "Asian" |
                                         puf_pad_grninf_preop$race == "Native Hawaiian or Pacific islander", TRUE, FALSE)
label(puf_pad_grninf_preop$othrace) <- "Other Race"

#No need to create a new variable for female.

#Create insulin dependent diabetes variable. The false value represent the patients with diabetes who are not insulin dependent.

puf_pad_grninf_preop$dm_ins <- ifelse(puf_pad_grninf_preop$dm_insulin == "Insulin", TRUE, FALSE)
puf_pad_grninf_preop$dm_ins <- ifelse(is.na(puf_pad_grninf_preop$dm_ins), 
                                        FALSE, puf_pad_grninf_preop$dm_ins)
label(puf_pad_grninf_preop$dm_ins) <- "Insulin-dependent Diabetes Mellitus"

puf_pad_grninf_preop$dm_nonins <- ifelse(puf_pad_grninf_preop$dm_insulin == "Meds or Diet", TRUE, FALSE)
puf_pad_grninf_preop$dm_nonins <- ifelse(is.na(puf_pad_grninf_preop$dm_nonins), 
                                      FALSE, puf_pad_grninf_preop$dm_nonins)
label(puf_pad_grninf_preop$dm_nonins) <- "Noninsulin-dependent Diabetes Mellitus"

#No need to create a new variable for smoker. Can utilize "smoke" variable.
label(puf_pad_grninf_preop$smoke) <- "Current Smoker"

#No need to create a new variable for hypertension. Can utilize "hypermed" variable.
label(puf_pad_grninf_preop$hypermed) <- "Hypertension on Medications"

#CAD (presence of MI, angina, percutaneous coronary intervention, or cardiac surgery). Since there is not MI or angina, will use heart_dz proxy variable

#No need to create a new variable for critical limb ischemia. Can use the clti variable created for the Leekha et al paper.

#Totally dependent functional status (fnstatus2).Based on the variables listed in fnstatus1 vs fnstatus2, I think we would want to use fnstatus2
puf_pad_grninf_preop$fnst_par <- ifelse(puf_pad_grninf_preop$fnstatus2 == "Partially dependent", TRUE, FALSE)
label(puf_pad_grninf_preop$fnst_par) <- "Partially Dependent Functional Status"

puf_pad_grninf_preop$fnst_dep <- ifelse(puf_pad_grninf_preop$fnstatus2 == "Totally dependent", TRUE, FALSE)
label(puf_pad_grninf_preop$fnst_dep) <- "Totally Dependent Functional Status"

#No need to create a new variable for COPD Can utilize "hxcopd" variable.
label(puf_pad_grninf_preop$hxcopd) <- "History of COPD"

#Create variable for dyspnea with moderate exertion. Can utilize the when_dyspnea variable. 
puf_pad_grninf_preop$dysp_mod <- ifelse(puf_pad_grninf_preop$when_dyspnea == "Moderate exertion", TRUE, FALSE)
puf_pad_grninf_preop$dysp_mod <- ifelse(is.na(puf_pad_grninf_preop$dysp_mod), 
                                         FALSE, puf_pad_grninf_preop$dysp_mod)
label(puf_pad_grninf_preop$dysp_mod) <- "Dyspnea with Moderate Exertion"

puf_pad_grninf_preop$dysp_rest <- ifelse(puf_pad_grninf_preop$when_dyspnea == "At rest", TRUE, FALSE)
puf_pad_grninf_preop$dysp_rest <- ifelse(is.na(puf_pad_grninf_preop$dysp_rest), 
                                        FALSE, puf_pad_grninf_preop$dysp_rest)
label(puf_pad_grninf_preop$dysp_rest) <- "Dyspnea at Rest"

#Neurological disease data is not available in this form of NSQIP.

#We will use the bleeddis and wtloss variable as is.
label(puf_pad_grninf_preop$bleeddis) <- "Bleeding Disorder"

## Create variable for aortoiliac and LE from previously developed CPT groups.

puf_pad_grninf_preop$proc_ai <- ifelse(puf_pad_grninf_preop$cpt %in% cpt_ai, TRUE, FALSE)
label(puf_pad_grninf_preop$proc_ai) <- "Procedure: Aortoiliac"

##Create variable for lower extremity bypass

puf_pad_grninf_preop$proc_ler <- ifelse(puf_pad_grninf_preop$cpt %in% cpt_le, TRUE, FALSE)
label(puf_pad_grninf_preop$proc_ler) <- "Procedure: Infrainguinal"

#We will utilize the emergncy variable

#Utilize optime variable already created for Gwilym et al but make it optime greater than 4-6 hours and >6hrs

puf_pad_grninf_preop$optime46h <- ifelse(puf_pad_grninf_preop$optime_hrs > "4" & puf_pad_grninf_preop$optime_hrs < "6", TRUE, FALSE)
puf_pad_grninf_preop$optime46h <- ifelse(is.na(puf_pad_grninf_preop$optime46h), 
                                         FALSE, puf_pad_grninf_preop$optime46h)
label(puf_pad_grninf_preop$optime46h) <- "Procedure Duration (4-6hrs)"
puf_pad_grninf_preop$optime6h <- ifelse(puf_pad_grninf_preop$optime_hrs > "6", TRUE, FALSE)
puf_pad_grninf_preop$optime6h <- ifelse(is.na(puf_pad_grninf_preop$optime6h), 
                                         FALSE, puf_pad_grninf_preop$optime6h)
label(puf_pad_grninf_preop$optime6h) <- "Procedure Duration (>6hrs)"

#Create variables for ASA clas 3 and ASA class 4 or for ASA class 5. Can utilize asaclas variable.
puf_pad_grninf_preop$asa_class_3 <-ifelse(puf_pad_grninf_preop$asaclas == "3", TRUE, FALSE)
label(puf_pad_grninf_preop$asa_class_3) <- "ASA Class 3"

puf_pad_grninf_preop$asa_class_45 <-ifelse(puf_pad_grninf_preop$asaclas == "4"| 
                                             puf_pad_grninf_preop$asaclas == "5", TRUE, FALSE)
label(puf_pad_grninf_preop$asa_class_45) <- "ASA Class 4 or 5"

# We will not include post-operative variables in our model, because the intention is for this to be used in the preoperative setting.  Therefore we will consider variables for renal, graft loss, sepsis, and prolonged LOS as negative.

w_exp <- c("female", "age65", "blkrace", "othrace", "overweight", "obese", "underweight", 
                 "dm_nonins", "dm_ins", "smoke", "hypermed", "heart_dz", "clti", "fnst_par", "fnst_dep", 
                 "hxcopd", "dysp_mod", "dysp_rest",  "bleeddis", "wtloss",
                 "emergncy", "optime46h", "optime6h", "proc_ai", "proc_ler", "vein", "prsth",
                 "asa_class_3","asa_class_45")
dep_1 <- "grninf"
dep_2 <- "s_grninf"
exp <- w_exp

puf_pad_grninf_preop %>%
  summary_factorlist(dep_1, exp, p=TRUE,
                     add_col_totals = TRUE,
                     include_col_totals_percent = FALSE,
                     col_totals_rowname = "",
                     col_totals_prefix = "N=") -> t2_1

t2_1 <- t2_1 %>%
  select(1,2,4,5) %>%
  rename("Any Groin SSI" = "TRUE")

puf_pad_grninf_preop %>%
  summary_factorlist(dep_2, exp, p=TRUE,
                     add_col_totals = TRUE,
                     include_col_totals_percent = FALSE,
                     col_totals_rowname = "",
                     col_totals_prefix = "N=",
                     total_col = TRUE) -> t2_2

selected_columns <- t2_2 %>%
  select(4,6,5) %>%
  rename("Severe Groin SSI" = "TRUE")

t2 <- t2_1 %>%
  bind_cols(selected_columns)

knitr::kable(t2, align = c("l", "l", "c", "c", "c", "c", "r"))

```

## Sorour et al Model

```{r Sorour Variables, warning=FALSE, echo=FALSE, message=FALSE}

# Model included 1 point for BMI >30, DM with insulin, COPD, immunosuppression, surgical duration >5hrs.

# We will use steroid as a proxy for immunosuppression
label(puf_pad_grninf_preop$smoke) <- "Immunosuppression or Steroid Use"

puf_pad_grninf_preop$optime5h <- ifelse(puf_pad_grninf_preop$optime_hrs > "5", TRUE, FALSE)
puf_pad_grninf_preop$optime5h <- ifelse(is.na(puf_pad_grninf_preop$optime5h), 
                                         FALSE, puf_pad_grninf_preop$optime5h)
label(puf_pad_grninf_preop$optime5h) <- "Procedure Duration (>5hrs)"

s_exp <- c("obese", "dm_ins", "dm_nonins", "hxcopd", "reop_groin", "steroid", "prsth", "optime_hrs")
dep_1 <- "grninf"
dep_2 <- "s_grninf"
exp <- s_exp

puf_pad_grninf_preop %>%
  summary_factorlist(dep_1, exp, p=TRUE,
                     add_col_totals = TRUE,
                     include_col_totals_percent = FALSE,
                     col_totals_rowname = "",
                     col_totals_prefix = "N=") -> t2_1

t2_1 <- t2_1 %>%
  select(1,2,4,5) %>%
  rename("Any Groin SSI" = "TRUE")

puf_pad_grninf_preop %>%
  summary_factorlist(dep_2, exp, p=TRUE,
                     add_col_totals = TRUE,
                     include_col_totals_percent = FALSE,
                     col_totals_rowname = "",
                     col_totals_prefix = "N=",
                     total_col = TRUE) -> t2_2

selected_columns <- t2_2 %>%
  select(4,6,5) %>%
  rename("Severe Groin SSI" = "TRUE")

t2 <- t2_1 %>%
  bind_cols(selected_columns)

knitr::kable(t2, align = c("l", "l", "c", "c", "c", "c", "r"))

```

## Eslami et al Model

```{r Eslami,warning=FALSE, message=FALSE, echo=FALSE}

## Eslami et al included mFI - they used the mFI 11, however many of these variables are no longer available in NSQIP and a shorter mFI 5 has been described (Subramaniam et al).  We will use this one.  We will create variables, for functional status, diabetes, history of COPD, history of CHF, hypertension.

puf_pad_grninf_preop$fnst_any <- ifelse(puf_pad_grninf_preop$fnstatus2 == "Partially dependent" |
                                          puf_pad_grninf_preop$fnstatus2 == "Totally dependent", TRUE, FALSE)
#label(puf_pad_grninf_preop$fnst_any) <- "Dependent Functional Status (Partially or Totally)"

puf_pad_grninf_preop$dm_any <- ifelse(puf_pad_grninf_preop$dm_insulin == "Insulin" |
                                        puf_pad_grninf_preop$dm_insulin == "Meds or Diet", TRUE, FALSE)
puf_pad_grninf_preop$dm_any <- ifelse(is.na(puf_pad_grninf_preop$dm_any), 
                                        FALSE, puf_pad_grninf_preop$dm_any)
#label(puf_pad_grninf_preop$dm_any) <- "Diabetes Mellitus"

#Create COPD using hxCOPD 
puf_pad_grninf_preop$copd <- ifelse(puf_pad_grninf_preop$hxcopd == "TRUE", TRUE, FALSE)
#label(puf_pad_grninf_preop$copd) <- "COPD"

#Create CHF using hxCHF
puf_pad_grninf_preop$CHF <- ifelse(puf_pad_grninf_preop$hxchf == "TRUE", TRUE, FALSE)
#label(puf_pad_grninf_preop$CHF) <- "CHF"

#Proxy for hypertension by using the hypermed category 
puf_pad_grninf_preop$htn <- ifelse(puf_pad_grninf_preop$hypermed == "TRUE", TRUE, FALSE)
#label(puf_pad_grninf_preop$htn) <- "HTN"

#Create 5 variable modified frailty index 
puf_pad_grninf_preop$mFI = (puf_pad_grninf_preop$fnst_any + puf_pad_grninf_preop$dm_any + puf_pad_grninf_preop$copd + puf_pad_grninf_preop$CHF + puf_pad_grninf_preop$htn)/5
puf_pad_grninf_preop$mFI <- remove_var_label(puf_pad_grninf_preop$mFI)

#Create binary variable for Cr 1.5-2 and Cr>2
puf_pad_grninf_preop$cr_152 <- ifelse(puf_pad_grninf_preop$prcreat > 1.5 & puf_pad_grninf_preop$prcreat < 2, TRUE, FALSE)
label(puf_pad_grninf_preop$cr_152) <- "Creatinine 1.5-2.0 mg/dL"

puf_pad_grninf_preop$cr_gr2 <- ifelse(puf_pad_grninf_preop$prcreat >= 2, TRUE, FALSE)
label(puf_pad_grninf_preop$cr_gr2) <- "Creatinine > 2.0 mg/dL"
                        

#Utilize ASA class variable, age, and female which are already developed 

e_exp <- c("fnst_any", "dm_any", "hxcopd", "CHF", "hypermed", "mFI", "age", "female", "overweight", "obese", "cr_152", "cr_gr2", "asa_class_3", "asa_class_45")
dep_1 <- "grninf"
dep_2 <- "s_grninf"
exp <- e_exp

puf_pad_grninf_preop %>%
  summary_factorlist(dep_1, exp, p=TRUE,
                     add_col_totals = TRUE,
                     include_col_totals_percent = FALSE,
                     col_totals_rowname = "",
                     col_totals_prefix = "N=") -> t2_1

t2_1 <- t2_1 %>%
  select(1,2,4,5) %>%
  rename("Any Groin SSI" = "TRUE")

puf_pad_grninf_preop %>%
  summary_factorlist(dep_2, exp, p=TRUE,
                     add_col_totals = TRUE,
                     include_col_totals_percent = FALSE,
                     col_totals_rowname = "",
                     col_totals_prefix = "N=",
                     total_col = TRUE) -> t2_2

selected_columns <- t2_2 %>%
  select(4,6,5) %>%
  rename("Severe Groin SSI" = "TRUE")

t2 <- t2_1 %>%
  bind_cols(selected_columns)

knitr::kable(t2, align = c("l", "l", "c", "c", "c", "c", "r"))

```

## Aziz et al Model

```{r Aziz Variables, warning=FALSE, echo=FALSE, message=FALSE}

# Model included wound disruption, organ space infection, LOS > 28 days, postoperative bleeding requiring transfusion, postoperative UTI, unplanned reoperation, BMI > 40, op time > 300 mins, prior ipsilateral intervention (percutaneous or bypass), COPD

#We will exclude wound disruption, organ space infection, LOS > 28 days, postoperative bleeding requiring transfusion, unplanned reoperation and postoperative UTI since these are all postoperative variables.

#For prior ipsilateral intervention, we will use the reoperative groin variable that was created for Leekha et al
puf_pad_grninf_preop$prrevasc <- ifelse(puf_pad_grninf_preop$pad_hrf_anat == "Prior ipsilateral bypass" | 
                                          puf_pad_grninf_preop$pad_hrf_anat == "Prior ipsilateral percutaneous intervention" |
                                          puf_pad_grninf_preop$podiag_combined %in% icd_prrevasc |
                                          puf_pad_grninf_preop$cpt %in% cpt_prrevasc, TRUE, FALSE)
puf_pad_grninf_preop$prrevasc <- ifelse(is.na(puf_pad_grninf_preop$prrevasc), 
                                      FALSE, puf_pad_grninf_preop$prrevasc)
label(puf_pad_grninf_preop$prrevasc) <- "Previous Ipsilateral Revascularization"


#Op time > 300 minutes (5 hours) will reuse variable created for Souror
puf_pad_grninf_preop$optime5h <- ifelse(puf_pad_grninf_preop$optime_hrs > "5", TRUE, FALSE)
puf_pad_grninf_preop$optime5h <- ifelse(is.na(puf_pad_grninf_preop$optime5h), 
                                         FALSE, puf_pad_grninf_preop$optime5h)
label(puf_pad_grninf_preop$optime5h) <- "Procedure Duration (>5hrs)"

label(puf_pad_grninf_preop$optime5h) <- "Procedure Duration (>5hrs)"

#Utilize hxCOPD variable for COPD.
puf_pad_grninf_preop$copd <- ifelse(puf_pad_grninf_preop$hxcopd == "TRUE", TRUE, FALSE)
label(puf_pad_grninf_preop$copd) <- "COPD"

#Create variable for BMI > 40 
puf_pad_grninf_preop$BMI40 <- ifelse(puf_pad_grninf_preop$BMI > "40", TRUE, FALSE)
puf_pad_grninf_preop$BMI40 <- ifelse(is.na(puf_pad_grninf_preop$BMI40), 
                                          FALSE, puf_pad_grninf_preop$BMI40)
label(puf_pad_grninf_preop$BMI40) <- "BMI40 (BMI>40)"

a_exp <- c("prrevasc", "optime5h", "hxcopd", "BMI40")
dep_1 <- "grninf"
dep_2 <- "s_grninf"
exp <- a_exp

puf_pad_grninf_preop %>%
  summary_factorlist(dep_1, exp, p=TRUE,
                     add_col_totals = TRUE,
                     include_col_totals_percent = FALSE,
                     col_totals_rowname = "",
                     col_totals_prefix = "N=") -> t2_1

t2_1 <- t2_1 %>%
  select(1,2,4,5) %>%
  rename("Any Groin SSI" = "TRUE")

puf_pad_grninf_preop %>%
  summary_factorlist(dep_2, exp, p=TRUE,
                     add_col_totals = TRUE,
                     include_col_totals_percent = FALSE,
                     col_totals_rowname = "",
                     col_totals_prefix = "N=",
                     total_col = TRUE) -> t2_2

selected_columns <- t2_2 %>%
  select(4,6,5) %>%
  rename("Severe Groin SSI" = "TRUE")

t2 <- t2_1 %>%
  bind_cols(selected_columns)

knitr::kable(t2, align = c("l", "l", "c", "c", "c", "c", "r"))

```


## Kalish et al Model

```{r Kalish Variables, warning=FALSE, echo=FALSE, message=FALSE}

# Model included ABI < 0.35, procedure > 220 minutes, transfusion > 2 units pRBCs, chlorhexidine preparation (protective)

#Transfusion > 2 units pRBCs was excluded because it is a postoperative variable. 

#ABI does not exist in NSQIP, so was excluded.

# Chlorhexidine was found to be protective. We will use the same variable created for aqeous betadine developed for the Gwilym model. This was a proxy variable created because the common practice in the US is to utilize alcoholic chlorhexidine, and typically variation is seen when there is an open wound.

puf_pad_grninf_preop$prep_aq_beta <- ifelse(puf_pad_grninf_preop$wndinf == TRUE | 
                                          puf_pad_grninf_preop$wndclas == "2" | 
                                          puf_pad_grninf_preop$wndclas == "3" | 
                                          puf_pad_grninf_preop$wndclas == "4", 
                                        TRUE, FALSE)

#Create variable for operative time> 220 minutes
puf_pad_grninf_preop$optime220 <- ifelse(puf_pad_grninf_preop$optime >"220", TRUE, FALSE)
puf_pad_grninf_preop$optime220 <- ifelse(is.na(puf_pad_grninf_preop$optime220), 
                                         FALSE, puf_pad_grninf_preop$optime220)
label(puf_pad_grninf_preop$optime220) <- "Procedure Duration (>220)"


k_exp <- c("optime220", "prep_aq_beta")
dep_1 <- "grninf"
dep_2 <- "s_grninf"
exp <- k_exp

puf_pad_grninf_preop %>%
  summary_factorlist(dep_1, exp, p=TRUE,
                     add_col_totals = TRUE,
                     include_col_totals_percent = FALSE,
                     col_totals_rowname = "",
                     col_totals_prefix = "N=") -> t2_1

t2_1 <- t2_1 %>%
  select(1,2,4,5) %>%
  rename("Any Groin SSI" = "TRUE")

puf_pad_grninf_preop %>%
  summary_factorlist(dep_2, exp, p=TRUE,
                     add_col_totals = TRUE,
                     include_col_totals_percent = FALSE,
                     col_totals_rowname = "",
                     col_totals_prefix = "N=",
                     total_col = TRUE) -> t2_2

selected_columns <- t2_2 %>%
  select(4,6,5) %>%
  rename("Severe Groin SSI" = "TRUE")

t2 <- t2_1 %>%
  bind_cols(selected_columns)

knitr::kable(t2, align = c("l", "l", "c", "c", "c", "c", "r"))

```


# Discrimination and Calbiration

Once the variables were developed, each of the four models was evaluated on the NSQIP dataset. This was done by utilizing the equations from each paper. Below is the code for the calculating each prediction term based on the information included in the publication and comparison of AUC and calibration curves.

```{r calculate prediction and nomogram values, warning=FALSE, message=FALSE, echo=FALSE}

attach(puf_pad_grninf_preop)

# Calculate predicted values for Gwilym et al
puf_pad_grninf_preop$g_beta <- -4.846 +
         0.535*(female) +
         0.629*(underweight) +
         0.264*(overweight) +
         1.070*(obese) +
         0.793*(heart_dz) -
         #0.394*(prep_aq_chlo) -
         #0.058*(prep_al_beta) +
         1.024*(prep_aq_beta) +
         #0.021*(prep_two_thr) +
         0.884*(vein) +
         0.938*(prsth) +
         0.142*(optime_hrs)
puf_pad_grninf_preop$g_pred <- 1 / (1+exp(-puf_pad_grninf_preop$g_beta))

#Calculate predicted values for Gwilym et al deep SSI model
puf_pad_grninf_preop$gd_beta <- -4.262 +
         0.666*(female) +
         0.666*(dm_any) -
         #0.108*(prep_aq_chlo) -
         #0.332*(prep_al_beta) +
         1.418*(prep_aq_beta) +
         #0.207*(prep_two_thr) +
         0.027*(vein) +
         0.325*(prsth)
puf_pad_grninf_preop$gd_pred <- 1 / (1+exp(-puf_pad_grninf_preop$gd_beta))

#Calculate predicted values for Leekha et al
puf_pad_grninf_preop$l_beta <- 1.07*(clti) +
          0.74*(hxcopd) +
          0.99*(prrevasc_ips)
puf_pad_grninf_preop$l_pred <- 1 / (1+exp(-puf_pad_grninf_preop$l_beta))



puf_pad_grninf_preop$l_score <-
  1*clti +
  1*hxcopd +
  1*prrevasc_ips +
  2*(0)

puf_pad_grninf_preop$l_nomo <- case_when(
  puf_pad_grninf_preop$l_score == 0 ~ 0.01,
  puf_pad_grninf_preop$l_score == 1 ~ 0.03,
  puf_pad_grninf_preop$l_score == 2 ~ 0.06,
  puf_pad_grninf_preop$l_score == 3 ~ 0.12,
  puf_pad_grninf_preop$l_score == 4 ~ 0.28,
  puf_pad_grninf_preop$l_score == 5 ~ 0.49
)

#Calculate predicted values for Bennett et al
puf_pad_grninf_preop$b_beta <- log(3.01)*(reop_groin) +
             log(3.46)*(female) +
             log(1.01)*(BMI) +
             log(4.37)*(esrd) +
             log(7.22)*(malnut) +
             log(2.98)*(urgnt)
puf_pad_grninf_preop$b_pred <- 1 / (1+exp(-puf_pad_grninf_preop$b_beta))

#Calculate predicted values for Wiseman et al 
puf_pad_grninf_preop$w_beta <- log(1.4)*(female) +
                log(0.9)*(age65) +
                log(0.8)*(blkrace) +
                log(0.9)*(othrace) +
                log(1.3)*(overweight) +
                log(2.3)*(obese) +
                log(0.8)*(underweight) +
                log(1.3)*(dm_ins) + 
                log(1.2)*(dm_nonins) +
                log(1.2)*(smoke) +
                log(1.2)*(hypermed) +
                log(1.1)*(heart_dz) +
                log(1.2)*(clti) +
                log(1.1)*(fnst_par) +
                log(0.5)*(fnst_dep) +
                log(1.1)*(hxcopd) +
                #log(1.1)*(neuro) +
                log(1.4)*(optime46h) +
                log(1.5)*(optime6h) +
                log(2.4)*(proc_ai) +
                log(3.1)*(proc_ler) +
                log(1.2) +
                log(0.9)*(vein) +
                log(0.8)*(prsth) +
                log(1.1)*(asa_class_3) +
                log(1.2)*(asa_class_45)
puf_pad_grninf_preop$w_pred <- 1 / (1+exp(-puf_pad_grninf_preop$w_beta)) 

puf_pad_grninf_preop$w_score <-
  12*proc_ler +
  9*proc_ai +
  9*obese +
  5*optime6h +
  4*female +
  3*overweight +
  3*optime46h +
  3*dm_ins +
  2*dm_nonins +
  2*smoke +
  2*hypermed +
  2*clti +
  2*(0) + #dyspnea with moderate exercise
  2*(1) + #groin anastomosis
  2*asa_class_45 +
  1*hxcopd +
  1*heart_dz +
  #1*neuro -
  1*age65 -
  2*blkrace -
  4*(0) - #sepsis complication
  6*(0) - #renal complication
  6*fnst_dep -
  9*(0) #LOS >14d

puf_pad_grninf_preop$w_nomo <- case_when(
  puf_pad_grninf_preop$w_score < 16 ~ 0.021,
  puf_pad_grninf_preop$w_score >= 16 & puf_pad_grninf_preop$w_score <= 20 ~ 0.051,
  puf_pad_grninf_preop$w_score >= 21 & puf_pad_grninf_preop$w_score <= 25 ~ 0.078,
  puf_pad_grninf_preop$w_score >25 ~ 0.14
)

puf_pad_grninf_preop$s_score <- obese + dm_ins + hxcopd + optime5h

puf_pad_grninf_preop$s_nomo <- case_when(
  puf_pad_grninf_preop$s_score == 0 ~ 0.12,
  puf_pad_grninf_preop$s_score == 1 ~ 0.10,
  puf_pad_grninf_preop$s_score == 2 ~ 0.12,
  puf_pad_grninf_preop$s_score == 3 ~ 0.43,
  puf_pad_grninf_preop$s_score == 4 ~ 0.6,
  puf_pad_grninf_preop$s_score == 5 ~ 1.0
)

#Calculate predicted values for Eslami et al 
puf_pad_grninf_preop$mFI <- as.numeric(puf_pad_grninf_preop$mFI)

puf_pad_grninf_preop$e_beta <- log(1.01)*(mFI) +
                log(0.98)*(age) +
                log(1.3)*(female) +
                log(1.44)*(overweight) +
                log(2.73)*(obese) +
                log(0.86)*(cr_152) +
                log(1.33)*(cr_gr2) +
                log(1.08)*(asa_class_3) + 
                log(1.86)*(asa_class_45)
puf_pad_grninf_preop$e_pred <- 1 / (1+exp(-puf_pad_grninf_preop$e_beta))

#Calculate predicted values for Aziz et al 
puf_pad_grninf_preop$a_beta <- log(2.28)*(BMI40) +
  log(1.98)*(optime5h) +
  log(1.98)*(prrevasc_ips) +
  log(1.73)*(hxcopd)
puf_pad_grninf_preop$a_pred <- 1 / (1+exp(-puf_pad_grninf_preop$a_beta))

#Calculate predicted values for Kalish et al 
puf_pad_grninf_preop$k_beta <- 
  #log(1.54)*(abi_35) +
  log(2.11)*(optime220) +
  log(0.53)*(1 - prep_aq_beta)
puf_pad_grninf_preop$k_pred <- 1 / (1+exp(-puf_pad_grninf_preop$k_beta))

puf_pad_grninf_preop$k_score <- optime220 + prep_aq_beta

puf_pad_grninf_preop$k_nomo <- case_when(
  puf_pad_grninf_preop$k_score == 1 ~ 0.032,
  puf_pad_grninf_preop$k_score == 2 ~ 0.048
)

puf_pad_grninf_preop <- puf_pad_grninf_preop[ , !(names(puf_pad_grninf_preop) %in% c("g_beta", "gd_beta", "l_beta", "b_beta", "w_beta", 
                                                                                     "l_score", "w_score", "s_score", "e_beta", 
                                                                                     "a_beta", "k_beta", "k_score"))]
```

## Discrimintation for Any Groin SSI

```{r ROC Curves for grninf, warning=FALSE, message=FALSE, echo=FALSE}
# Plot ROC and calculate AUC using the yardstick package, which is a part of tidymodels
puf_pad_grninf_preop$grninf <- as.factor(puf_pad_grninf_preop$grninf)

# Define the predictors and outcome - we will use the nomograms in place of the predictor values because discrimination has been found to be maintained
predictors <- list("a_pred", "b_pred", "e_pred", "g_pred", "gd_pred", "k_pred", "l_nomo", "s_nomo", "w_nomo")

# Define a list to store the results
results <- list()

# Loop through each predictor - need to indicate that the event level is second because TRUE comes after FALSE
for (pred in predictors) {
  roc <- roc_curve(puf_pad_grninf_preop, dep_1, pred, event_level = "second")
  auc <- roc_auc(puf_pad_grninf_preop, dep_1, pred, event_level = "second")
  auc_round <- round(auc$.estimate, 2)
  
  # Store the results in the list
  results[[pred]] <- list(roc = roc, auc = auc, auc_round = auc_round)
}

combined_data <- rbind(
  data.frame(Model = "Aziz", Sensitivity = results$a_pred$roc$sensitivity, Specificity = results$a_pred$roc$specificity),
  data.frame(Model = "Bennett", Sensitivity = results$b_pred$roc$sensitivity, Specificity = results$b_pred$roc$specificity),
  data.frame(Model = "Eslami", Sensitivity = results$e_pred$roc$sensitivity, Specificity = results$e_pred$roc$specificity),
  data.frame(Model = "Gwilym", Sensitivity = results$g_pred$roc$sensitivity, Specificity = results$g_pred$roc$specificity),
  data.frame(Model = "Gwilym - Deep", Sensitivity = results$gd_pred$roc$sensitivity, Specificity = results$gd_pred$roc$specificity),
  data.frame(Model = "Kalish", Sensitivity = results$k_pred$roc$sensitivity, Specificity = results$k_pred$roc$specificity),
  data.frame(Model = "Leekha", Sensitivity = results$l_nomo$roc$sensitivity, Specificity = results$l_nomo$roc$specificity),
  data.frame(Model = "Souror", Sensitivity = results$s_nomo$roc$sensitivity, Specificity = results$s_nomo$roc$specificity),
  data.frame(Model = "Wiseman", Sensitivity = results$w_nomo$roc$sensitivity, Specificity = results$w_nomo$roc$specificity)
)

# Create the plot
ggplot(combined_data, aes(x = 1 - Specificity, y = Sensitivity, color = Model)) +
  geom_line() +
  labs(title = "Combined ROC Curve", x = "False Positive Rate", y = "True Positive Rate") +
  scale_color_manual(values = c("black", "gray", "brown", "red", "goldenrod", "green", "cyan", "blue", "magenta")) +
  geom_abline(intercept = 0, slope = 1, linetype = "dashed", color = "gray") +
  annotate("text", x = 0.75, y = 0.45, label = paste("AUC =", results$a_pred$auc_round), col = "black") +
  annotate("text", x = 0.75, y = 0.40, label = paste("AUC =", results$b_pred$auc_round), col = "gray") +
  annotate("text", x = 0.75, y = 0.35, label = paste("AUC =", results$e_pred$auc_round), col = "brown") +
  annotate("text", x = 0.75, y = 0.30, label = paste("AUC =", results$g_pred$auc_round), col = "red") +
  annotate("text", x = 0.75, y = 0.25, label = paste("AUC =", results$gd_pred$auc_round), col = "goldenrod") +
  annotate("text", x = 0.75, y = 0.20, label = paste("AUC =", results$k_pred$auc_round), col = "green") +
  annotate("text", x = 0.75, y = 0.15, label = paste("AUC =", results$l_nomo$auc_round), col = "cyan") +
  annotate("text", x = 0.75, y = 0.10, label = paste("AUC =", results$s_nomo$auc_round), col = "blue") +
  annotate("text", x = 0.75, y = 0.05, label = paste("AUC =", results$w_nomo$auc_round), col = "magenta")
```

### Discriminiation for Severe Groin SSI

```{r ROC Curves for s_grninf, warning=FALSE, message=FALSE, echo=FALSE}
# Plot ROC and calculate AUC using the yardstick package, which is a part of tidymodels
puf_pad_grninf_preop$s_grninf <- as.factor(puf_pad_grninf_preop$s_grninf)

# Define the predictors and outcome - we will use the nomograms in place of the predictor values because discrimination has been found to be maintained
predictors <- list("a_pred", "b_pred", "e_pred", "g_pred", "gd_pred", "k_pred", "l_nomo", "s_nomo", "w_nomo")

# Define a list to store the results
results <- list()

# Loop through each predictor - need to indicate that the event level is second because TRUE comes after FALSE
for (pred in predictors) {
  roc <- roc_curve(puf_pad_grninf_preop, dep_2, pred, event_level = "second")
  auc <- roc_auc(puf_pad_grninf_preop, dep_2, pred, event_level = "second")
  auc_round <- round(auc$.estimate, 2)
  
  # Store the results in the list
  results[[pred]] <- list(roc = roc, auc = auc, auc_round = auc_round)
}

combined_data <- rbind(
  data.frame(Model = "Aziz", Sensitivity = results$a_pred$roc$sensitivity, Specificity = results$a_pred$roc$specificity),
  data.frame(Model = "Bennett", Sensitivity = results$b_pred$roc$sensitivity, Specificity = results$b_pred$roc$specificity),
  data.frame(Model = "Eslami", Sensitivity = results$e_pred$roc$sensitivity, Specificity = results$e_pred$roc$specificity),
  data.frame(Model = "Gwilym", Sensitivity = results$g_pred$roc$sensitivity, Specificity = results$g_pred$roc$specificity),
  data.frame(Model = "Gwilym - Deep", Sensitivity = results$gd_pred$roc$sensitivity, Specificity = results$gd_pred$roc$specificity),
  data.frame(Model = "Kalish", Sensitivity = results$k_pred$roc$sensitivity, Specificity = results$k_pred$roc$specificity),
  data.frame(Model = "Leekha", Sensitivity = results$l_nomo$roc$sensitivity, Specificity = results$l_nomo$roc$specificity),
  data.frame(Model = "Souror", Sensitivity = results$s_nomo$roc$sensitivity, Specificity = results$s_nomo$roc$specificity),
  data.frame(Model = "Wiseman", Sensitivity = results$w_nomo$roc$sensitivity, Specificity = results$w_nomo$roc$specificity)
)

# Create the plot
ggplot(combined_data, aes(x = 1 - Specificity, y = Sensitivity, color = Model)) +
  geom_line() +
  labs(title = "Combined ROC Curve", x = "False Positive Rate", y = "True Positive Rate") +
  scale_color_manual(values = c("black", "gray", "brown", "red", "goldenrod", "green", "cyan", "blue", "magenta")) +
  geom_abline(intercept = 0, slope = 1, linetype = "dashed", color = "gray") +
  annotate("text", x = 0.75, y = 0.45, label = paste("AUC =", results$a_pred$auc_round), col = "black") +
  annotate("text", x = 0.75, y = 0.40, label = paste("AUC =", results$b_pred$auc_round), col = "gray") +
  annotate("text", x = 0.75, y = 0.35, label = paste("AUC =", results$e_pred$auc_round), col = "brown") +
  annotate("text", x = 0.75, y = 0.30, label = paste("AUC =", results$g_pred$auc_round), col = "red") +
  annotate("text", x = 0.75, y = 0.25, label = paste("AUC =", results$gd_pred$auc_round), col = "goldenrod") +
  annotate("text", x = 0.75, y = 0.20, label = paste("AUC =", results$k_pred$auc_round), col = "green") +
  annotate("text", x = 0.75, y = 0.15, label = paste("AUC =", results$l_nomo$auc_round), col = "cyan") +
  annotate("text", x = 0.75, y = 0.10, label = paste("AUC =", results$s_nomo$auc_round), col = "blue") +
  annotate("text", x = 0.75, y = 0.05, label = paste("AUC =", results$w_nomo$auc_round), col = "magenta")
```

## Calibration for Any Groin SSI

```{r calibration plots for any groin SSI, warning=FALSE, message=FALSE, echo=FALSE}

combined_cal <- rbind(
  data.frame(model = "Gwilym", grninf = puf_pad_grninf_preop$grninf, .pred_TRUE = puf_pad_grninf_preop$g_pred),
  data.frame(model = "Gwilym - Deep", grninf = puf_pad_grninf_preop$grninf, .pred_TRUE = puf_pad_grninf_preop$gd_pred),
  data.frame(model = "Kalish", grninf = puf_pad_grninf_preop$grninf, .pred_TRUE = puf_pad_grninf_preop$k_nomo),
  data.frame(model = "Leehka", grninf = puf_pad_grninf_preop$grninf, .pred_TRUE = puf_pad_grninf_preop$l_nomo),
  data.frame(model = "Souror", grninf = puf_pad_grninf_preop$grninf, .pred_TRUE = puf_pad_grninf_preop$s_nomo),
  data.frame(model = "Wiseman", grninf = puf_pad_grninf_preop$grninf, .pred_TRUE = puf_pad_grninf_preop$w_nomo)
)

min_pred <- min(combined_cal$.pred_TRUE, na.rm = TRUE)
max_pred <- max(combined_cal$.pred_TRUE, na.rm = TRUE)

filtered_cal <- combined_cal %>%
  filter(.pred_TRUE >= min_pred & .pred_TRUE <= max_pred)

filtered_cal %>%
  cal_plot_windowed(grninf, .pred_TRUE, .by = model, event_level = "second", step_size = 0.025, include_points = FALSE) +
  facet_wrap(~model) +
  theme(legend.position = "none")

#combined_cal %>%
#  cal_plot_logistic(grninf, .pred_TRUE, .by = model, event_level = "second", smooth = FALSE) +
#  facet_wrap(~model) +
#  theme(legend.position = "none")

```

## Calibration for Severe Groin SSI

```{r calibration plots for severe groin SSI, warning=FALSE, message=FALSE, echo=FALSE}

combined_cal <- rbind(
  data.frame(model = "Gwilym", grninf = puf_pad_grninf_preop$s_grninf, .pred_TRUE = puf_pad_grninf_preop$g_pred),
  data.frame(model = "Gwilym - Deep", grninf = puf_pad_grninf_preop$s_grninf, .pred_TRUE = puf_pad_grninf_preop$gd_pred),
  data.frame(model = "Kalish", grninf = puf_pad_grninf_preop$s_grninf, .pred_TRUE = puf_pad_grninf_preop$k_nomo),
  data.frame(model = "Leehka", grninf = puf_pad_grninf_preop$s_grninf, .pred_TRUE = puf_pad_grninf_preop$l_nomo),
  data.frame(model = "Souror", grninf = puf_pad_grninf_preop$s_grninf, .pred_TRUE = puf_pad_grninf_preop$s_nomo),
  data.frame(model = "Wiseman", grninf = puf_pad_grninf_preop$s_grninf, .pred_TRUE = puf_pad_grninf_preop$w_nomo)
)


min_pred <- min(combined_cal$.pred_TRUE, na.rm = TRUE)
max_pred <- max(combined_cal$.pred_TRUE, na.rm = TRUE)

filtered_cal <- combined_cal %>%
  filter(.pred_TRUE >= min_pred & .pred_TRUE <= max_pred)

filtered_cal %>%
  cal_plot_windowed(grninf, .pred_TRUE, .by = model, event_level = "second", step_size = 0.025, include_points = FALSE) +
  facet_wrap(~model) +
  theme(legend.position = "none")

#combined_cal %>%
#  cal_plot_logistic(grninf, .pred_TRUE, .by = model, event_level = "second", smooth = FALSE) +
#  facet_wrap(~model) +
#  theme(legend.position = "none")

```

# Export data

```{r export data, echo=FALSE, warning=FALSE, message=FALSE}

puf_pad_grninf_preop$grninf <- as.logical(puf_pad_grninf_preop$grninf)

saveRDS(puf_pad_grninf_preop, file="P:/Pro00113988 - PAD Risk Models/DataRepo/NSQIP/Analysis Data Files/puf_pad_grninf_preop.rds")

```

